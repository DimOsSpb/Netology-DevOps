---
- name: test
  gather_facts: false
  hosts: all
  vars:
    ansible_ssh_user: ubuntu
    secrets: >
      {{
        dict(groups['all'] | zip(
          groups['all'] | map('regex_replace', '^.*$', 'default_password')
        ))
      }}
  become: yes



  pre_tasks:
    - name: Validating the ssh port is open and
      wait_for:
        host: '{{ (ansible_ssh_host|default(ansible_host))|default(inventory_hostname) }}'
        port: 22
        delay: 5
        timeout: 300
        state: started
        search_regex: OpenSSH

    - name: debug host identity
      debug:
        msg: |
          inventory_hostname: {{ inventory_hostname }}
          ansible_host: {{ ansible_host | default('undefined') }}
          secrets keys: {{ secrets.keys() | list }}

  tasks:
    - name: save own secret
      copy:
        dest: /tmp/own.pass
        content: "{{ secrets[inventory_hostname]  }}"
      when: secrets[inventory_hostname] is defined

    - name: save all secrets
      copy:
        dest: /tmp/all.pass
        content: "{{ secrets }}"
      when: secrets is defined
